<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StyleHub - Secure Checkout</title>
    <link rel="stylesheet" href="./css/payment.css">

</head>

<body>
    <!-- Page 1: Delivery Information -->
    <div id="page-1" class="container">
        <header>
            <a href="dashboard.html" class="logo">
                <div class="logo-circle">S</div>
                <span>StyleHub</span>
            </a>
            <div class="secure-tag">Secure Checkout</div>
        </header>

        <p class="instruction">Please provide your delivery details</p>

        <div class="checkout-container">
            <div class="main-content">
                <h2>Delivery Information</h2>

                <form id="delivery-form">
                    <div class="form-row">
                        <div class="form-column">
                            <label for="fullName">Full Name</label>
                            <input type="text" id="fullName" placeholder="John Doe">
                            <div id="nameError" class="error-label" style="display: none;">Full name must be at least 3
                                characters</div>
                        </div>
                        <div class="form-column">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" placeholder="98XXXXXXXX">
                            <div id="phoneError" class="error-label" style="display: none;">Please enter a valid phone
                                number</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="address">Delivery Address</label>
                        <textarea id="address" placeholder="Street address, House number"></textarea>
                        <div id="addressError" class="error-label" style="display: none;">Please enter your complete
                            address</div>
                    </div>

                    <div class="form-row">
                        <div class="form-column">
                            <label for="city">City</label>
                            <input type="text" id="city" placeholder="Kathmandu">
                            <div id="cityError" class="error-label" style="display: none;">Please enter your city</div>
                        </div>
                        <div class="form-column">
                            <label for="zipCode">Zip/Postal Code</label>
                            <input type="text" id="zipCode" placeholder="44600">
                            <div id="zipError" class="error-label" style="display: none;">Please enter a valid
                                zip/postal code</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Delivery Type</label>
                        <div class="radio-group">
                            <div class="radio-option selected" data-value="standard">
                                <div class="radio-input">
                                    <input type="radio" name="deliveryType" value="standard" checked
                                        style="display:none;">
                                </div>
                                <div class="radio-details">
                                    <div class="radio-title">Standard Delivery</div>
                                    <div class="radio-description">3-5 business days</div>
                                </div>
                                <div class="checkmark">✓</div>
                            </div>
                            <div class="radio-option" data-value="express">
                                <div class="radio-input">
                                    <input type="radio" name="deliveryType" value="express" style="display:none;">
                                </div>
                                <div class="radio-details">
                                    <div class="radio-title">Express Delivery</div>
                                    <div class="radio-description">1-2 business days</div>
                                </div>
                                <div class="checkmark"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="instructions">Delivery Instructions (Optional)</label>
                        <textarea id="instructions"
                            placeholder="Add any special instructions for delivery..."></textarea>
                    </div>

                    <button type="submit" class="button">Proceed to Payment</button>
                </form>
            </div>

            <div class="order-summary">
                <h3>Order Summary</h3>

                <div class="summary-row">
                    <span class="summary-label">Subtotal</span>
                    <span>Rs. 3499.00</span>
                </div>

                <div class="summary-row">
                    <span class="summary-label">Delivery</span>
                    <span>Rs. 150.00</span>
                </div>

                <div class="summary-row">
                    <span class="summary-label">Discount</span>
                    <span class="discount">- Rs. 200.00</span>
                </div>

                <div class="summary-row">
                    <span class="summary-label">Tax</span>
                    <span>Rs. 50.00</span>
                </div>

                <div class="total-row">
                    <span>Total</span>
                    <span>Rs. 3499.00</span>
                </div>

                <div class="promo">
                    <label for="promocode">Enter your promo code</label>
                    <input type="text" id="promocode" placeholder="Promo Code">
                </div>

                <div class="estimated-delivery">
                    <div class="delivery-date">Estimated Delivery</div>
                    <div class="delivery-time">Thursday, March 27, 2025</div>
                    <div class="delivery-time">3-5 business days</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page 2: Payment Method -->
    <div id="page-2" class="container" style="display: none;">
        <header>
            <a href="#" class="logo">
                <div class="logo-circle">S</div>
                <span>StyleHub</span>
            </a>
            <div class="secure-tag">Secure Checkout</div>
        </header>

        <div class="checkout-container">
            <div class="main-content">
                <h2>Checkout - Payment Method</h2>
                <p>Complete your purchase by choosing a payment method</p>

                <div class="form-group" style="margin-top: 30px;">
                    <h3>Payment Method</h3>
                    <a href="#" class="edit-link" id="edit-details">Edit Details</a>

                    <div class="delivery-address">
                        <div class="address-name">Delivery To:</div>
                        <div class="address-details" id="delivery-name">John Doe</div>
                        <div class="address-details" id="delivery-phone">9847391783</div>
                        <div class="address-details" id="delivery-full-address">Babarmahal, Kathmandu, 44600</div>
                        <div class="delivery-type">Standard Delivery (3-5 days)</div>
                    </div>

                    <div class="radio-group">
                        <div class="radio-option" data-value="cash" id="cash-option">
                            <div class="radio-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 7H21V17H3V7Z" stroke="white" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path
                                        d="M12 12C13.1046 12 14 11.1046 14 10C14 8.89543 13.1046 8 12 8C10.8954 8 10 8.89543 10 10C10 11.1046 10.8954 12 12 12Z"
                                        stroke="white" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M17 17C16.5 15.5 14.5 14 12 14C9.5 14 7.5 15.5 7 17" stroke="white"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            <div class="radio-details">
                                <div class="radio-title">Cash on Delivery</div>
                                <div class="radio-description">Pay when your order arrives</div>
                            </div>
                            <div class="checkmark"></div>
                        </div>

                        <div class="radio-option selected" data-value="khalti" id="khalti-option">
                            <div class="radio-icon" style="background-color: #5C2D91;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <rect width="24" height="24" rx="4" fill="#5C2D91" />
                                    <path d="M6 7V17M9 7L9 17M12 7V17M15 7V17M18 7V17" stroke="white" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            <div class="radio-details">
                                <div class="radio-title">Khalti</div>
                                <div class="radio-description">Pay now with Khalti digital wallet</div>
                            </div>
                            <div class="checkmark">✓</div>
                        </div>
                    </div>

                    <div id="cash-details" class="payment-details" style="display: none;">
                        <div class="radio-title">Cash on Delivery</div>
                        <div class="radio-description">You'll pay in cash when your order is delivered.</div>

                        <div class="payment-features">
                            <div class="payment-feature">
                                <span class="feature-check">✓</span>
                                <span>No advance payment required</span>
                            </div>
                            <div class="payment-feature">
                                <span class="feature-check">✓</span>
                                <span>Pay exact amount to the delivery person</span>
                            </div>
                            <div class="payment-feature">
                                <span class="feature-check">✓</span>
                                <span>Inspect your order before paying</span>
                            </div>
                        </div>
                    </div>

                    <div id="khalti-details" class="payment-details">
                        <div class="radio-title">Khalti Digital Wallet</div>
                        <div class="radio-description">Pay securely with your Khalti digital wallet.</div>

                        <div class="summary-row" style="margin-top: 15px;">
                            <span class="summary-label">Total amount:</span>
                            <span>Rs. 3499.00</span>
                        </div>

                        <button id="pay-khalti" class="button purple">Pay with Khalti</button>

                        <p style="font-size: 14px; color: #666; margin-top: 15px; text-align: center;">
                            By clicking "Pay with Khalti" you will be redirected to the Khalti secure payment gateway.
                        </p>

                        <p style="font-size: 14px; color: #4299e1; margin-top: 10px; text-align: center;">
                            <a href="#" style="color: #4299e1; text-decoration: none;">Learn more about Khalti</a>
                        </p>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label for="paymentInstructions">Delivery Instructions (Optional)</label>
                        <textarea id="paymentInstructions"
                            placeholder="Add any special instructions for delivery..."></textarea>
                    </div>

                    <button id="complete-order" class="button" style="display: none;">Complete Order</button>
                </div>
            </div>

            <div class="order-summary">
                <h3>Order Summary</h3>

                <div class="summary-row">
                    <span class="summary-label">Subtotal</span>
                    <span>Rs. 3499.00</span>
                </div>

                <div class="summary-row">
                    <span class="summary-label">Delivery</span>
                    <span>Rs. 150.00</span>
                </div>

                <div class="summary-row">
                    <span class="summary-label">Discount</span>
                    <span class="discount">- Rs. 200.00</span>
                </div>

                <div class="summary-row">
                    <span class="summary-label">Tax</span>
                    <span>Rs. 50.00</span>
                </div>

                <div class="total-row">
                    <span>Total</span>
                    <span>Rs. 3499.00</span>
                </div>

                <div class="estimated-delivery">
                    <div class="delivery-date">Estimated Delivery</div>
                    <div class="delivery-time">Thursday, March 27, 2025</div>
                    <div class="delivery-time">3-5 business days</div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Navigation between pages with smooth transitions
        const page1 = document.getElementById('page-1');
        const page2 = document.getElementById('page-2');

        // Form elements
        const deliveryForm = document.getElementById('delivery-form');
        const fullNameInput = document.getElementById('fullName');
        const phoneInput = document.getElementById('phone');
        const addressInput = document.getElementById('address');
        const cityInput = document.getElementById('city');
        const zipCodeInput = document.getElementById('zipCode');
        const instructionsInput = document.getElementById('instructions');
        const paymentInstructionsInput = document.getElementById('paymentInstructions');

        // Error elements
        const nameError = document.getElementById('nameError');
        const phoneError = document.getElementById('phoneError');
        const addressError = document.getElementById('addressError');
        const cityError = document.getElementById('cityError');
        const zipError = document.getElementById('zipError');

        // Summary elements
        const deliveryName = document.getElementById('delivery-name');
        const deliveryPhone = document.getElementById('delivery-phone');
        const deliveryFullAddress = document.getElementById('delivery-full-address');
        const deliveryTypeDisplay = document.querySelector('.delivery-type');

        // Payment options
        const cashOption = document.getElementById('cash-option');
        const khaltiOption = document.getElementById('khalti-option');
        const cashDetails = document.getElementById('cash-details');
        const khaltiDetails = document.getElementById('khalti-details');
        const payKhaltiBtn = document.getElementById('pay-khalti');
        const completeOrderBtn = document.getElementById('complete-order');
        const paymentToast = document.getElementById('payment-toast');
        const editDetailsLink = document.getElementById('edit-details');

        // Real-time validation
        const validateInput = (input, errorElement, condition, message) => {
            if (condition) {
                errorElement.style.display = 'none';
                input.style.borderColor = '#ddd';
                return true;
            } else {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                input.style.borderColor = '#e53e3e';
                return false;
            }
        };

        // Add input event listeners for real-time validation
        fullNameInput.addEventListener('input', function () {
            validateInput(
                this,
                nameError,
                this.value.length >= 3,
                'Full name must be at least 3 characters'
            );
        });

        phoneInput.addEventListener('input', function () {
            this.value = this.value.replace(/[^0-9]/g, '');
            validateInput(
                this,
                phoneError,
                this.value.length >= 10,
                'Please enter a valid phone number (at least 10 digits)'
            );
        });

        addressInput.addEventListener('input', function () {
            validateInput(
                this,
                addressError,
                this.value.trim() !== '',
                'Please enter your complete address'
            );
        });

        cityInput.addEventListener('input', function () {
            validateInput(
                this,
                cityError,
                this.value.trim() !== '',
                'Please enter your city'
            );
        });

        zipCodeInput.addEventListener('input', function () {
            validateInput(
                this,
                zipError,
                this.value.trim() !== '',
                'Please enter a valid zip/postal code'
            );
        });

        // Smooth page transitions
        const showPage = (pageToShow, pageToHide) => {
            // Fade out current page
            pageToHide.style.opacity = '0';
            pageToHide.style.transition = 'opacity 0.3s ease';

            setTimeout(() => {
                pageToHide.style.display = 'none';

                // Prepare next page
                pageToShow.style.opacity = '0';
                pageToShow.style.display = 'block';

                // Force reflow
                void pageToShow.offsetWidth;

                // Fade in next page
                pageToShow.style.transition = 'opacity 0.3s ease';
                pageToShow.style.opacity = '1';
            }, 300);
        };

        // Handle delivery form submission with enhanced validation
        deliveryForm.addEventListener('submit', function (e) {
            e.preventDefault();

            // Validate all inputs
            const isNameValid = validateInput(
                fullNameInput,
                nameError,
                fullNameInput.value.length >= 3,
                'Full name must be at least 3 characters'
            );

            const isPhoneValid = validateInput(
                phoneInput,
                phoneError,
                phoneInput.value.length >= 10,
                'Please enter a valid phone number (at least 10 digits)'
            );

            const isAddressValid = validateInput(
                addressInput,
                addressError,
                addressInput.value.trim() !== '',
                'Please enter your complete address'
            );

            const isCityValid = validateInput(
                cityInput,
                cityError,
                cityInput.value.trim() !== '',
                'Please enter your city'
            );

            const isZipValid = validateInput(
                zipCodeInput,
                zipError,
                zipCodeInput.value.trim() !== '',
                'Please enter a valid zip/postal code'
            );

            if (isNameValid && isPhoneValid && isAddressValid && isCityValid && isZipValid) {
                // Update delivery address on next page
                deliveryName.textContent = fullNameInput.value;
                deliveryPhone.textContent = phoneInput.value;
                deliveryFullAddress.textContent =
                    `${addressInput.value}, ${cityInput.value}, ${zipCodeInput.value}`;

                // Update delivery type display
                const selectedDeliveryType = document.querySelector('input[name="deliveryType"]:checked').value;
                deliveryTypeDisplay.textContent = selectedDeliveryType === 'standard' ?
                    'Standard Delivery (3-5 days)' :
                    'Express Delivery (1-2 days)';

                // Transfer delivery instructions if any
                if (instructionsInput.value.trim() !== '') {
                    paymentInstructionsInput.value = instructionsInput.value;
                }

                // Go to payment page with transition
                showPage(page2, page1);
            } else {
                // Scroll to first error
                const firstError = document.querySelector('.error-label[style="display: block"]');
                if (firstError) {
                    firstError.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }
        });

        // Smooth selection for payment options with improved visual feedback
        const selectPaymentOption = (selected, unselected, selectedDetails, unselectedDetails) => {
            // Add subtle animation for selection
            selected.style.transform = 'scale(1.03)';
            setTimeout(() => {
                selected.style.transform = 'scale(1)';
            }, 150);

            selected.classList.add('selected');
            unselected.classList.remove('selected');

            // Update checkmarks with smooth transition
            selected.querySelector('.checkmark').innerHTML = '✓';
            selected.querySelector('.checkmark').style.transition = 'background-color 0.3s ease';

            unselected.querySelector('.checkmark').innerHTML = '';

            // Show/hide payment details with smooth transition
            if (selectedDetails) {
                selectedDetails.style.display = 'block';
                selectedDetails.style.opacity = '0';

                // Force reflow
                void selectedDetails.offsetWidth;

                selectedDetails.style.transition = 'opacity 0.3s ease';
                selectedDetails.style.opacity = '1';
            }

            if (unselectedDetails) {
                unselectedDetails.style.opacity = '0';
                unselectedDetails.style.transition = 'opacity 0.3s ease';

                setTimeout(() => {
                    unselectedDetails.style.display = 'none';
                }, 300);
            }
        };

        // Handle payment option selection
        cashOption.addEventListener('click', function () {
            selectPaymentOption(cashOption, khaltiOption, cashDetails, khaltiDetails);

            // Show complete order button with fade in, hide khalti button
            payKhaltiBtn.style.opacity = '0';
            payKhaltiBtn.style.transition = 'opacity 0.3s ease';

            setTimeout(() => {
                payKhaltiBtn.style.display = 'none';
                completeOrderBtn.style.display = 'block';
                completeOrderBtn.style.opacity = '0';

                // Force reflow
                void completeOrderBtn.offsetWidth;

                completeOrderBtn.style.transition = 'opacity 0.3s ease';
                completeOrderBtn.style.opacity = '1';
            }, 300);
        });

        khaltiOption.addEventListener('click', function () {
            selectPaymentOption(khaltiOption, cashOption, khaltiDetails, cashDetails);

            // Hide complete order button, show khalti button
            completeOrderBtn.style.opacity = '0';
            completeOrderBtn.style.transition = 'opacity 0.3s ease';

            setTimeout(() => {
                completeOrderBtn.style.display = 'none';
                payKhaltiBtn.style.display = 'block';
                payKhaltiBtn.style.opacity = '0';

                // Force reflow
                void payKhaltiBtn.offsetWidth;

                payKhaltiBtn.style.transition = 'opacity 0.3s ease';
                payKhaltiBtn.style.opacity = '1';
            }, 300);
        });

        // Edit details with smooth transition back
        editDetailsLink.addEventListener('click', function (e) {
            e.preventDefault();
            showPage(page1, page2);
        });

        // Handle delivery type selection on first page with improved feedback
        const deliveryOptions = document.querySelectorAll('#page-1 .radio-option');
        deliveryOptions.forEach(option => {
            option.addEventListener('click', function () {
                // Add subtle animation
                this.style.transform = 'scale(1.03)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);

                // Remove selected class from all options
                deliveryOptions.forEach(opt => {
                    opt.classList.remove('selected');
                    opt.querySelector('.checkmark').innerHTML = '';
                });

                // Add selected class to clicked option
                this.classList.add('selected');
                this.querySelector('.checkmark').innerHTML = '✓';

                // Update radio input
                this.querySelector('input[type="radio"]').checked = true;
            });
        });

        // Enhanced payment processing with visual feedback
        payKhaltiBtn.addEventListener('click', function (e) {
            e.preventDefault();

            // Disable button and show loading state
            this.disabled = true;
            this.style.opacity = '0.7';
            this.innerHTML = '<span id="loading-spinner">Processing...</span>';

            // Create and add loading spinner animation
            const spinner = document.getElementById('loading-spinner');
            spinner.style.position = 'relative';
            spinner.style.paddingLeft = '25px';

            const loaderElement = document.createElement('div');
            loaderElement.style.position = 'absolute';
            loaderElement.style.left = '0';
            loaderElement.style.top = '50%';
            loaderElement.style.transform = 'translateY(-50%)';
            loaderElement.style.width = '18px';
            loaderElement.style.height = '18px';
            loaderElement.style.border = '2px solid rgba(255,255,255,0.3)';
            loaderElement.style.borderTop = '2px solid white';
            loaderElement.style.borderRadius = '50%';
            loaderElement.style.animation = 'spin 1s linear infinite';

            // Add keyframes for spinner
            const styleElement = document.createElement('style');
            styleElement.innerHTML = `
        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }
    `;
            document.head.appendChild(styleElement);

            spinner.appendChild(loaderElement);

            // Redirect to the invoice page or process payment without showing page 3
            setTimeout(function () {
                submitOrder("khalti");
            }, 2000);
        });

        // Smoother completion for cash option
        completeOrderBtn.addEventListener('click', function (e) {
            e.preventDefault();

            // Disable button and show brief loading state
            this.disabled = true;
            this.style.opacity = '0.7';
            this.innerHTML = 'Processing...';

            // Submit order with "cod" payment method
            submitOrder("cod");
        });

        // Initialize page styling for transitions
        page1.style.transition = 'opacity 0.3s ease';
        page2.style.transition = 'opacity 0.3s ease';

        // Add focus styling for better accessibility
        const focusableElements = document.querySelectorAll('input, textarea, button, [tabindex="0"]');
        focusableElements.forEach(element => {
            element.addEventListener('focus', function () {
                this.style.boxShadow = '0 0 0 3px rgba(66, 153, 225, 0.5)';
                this.style.transition = 'box-shadow 0.2s ease';
            });

            element.addEventListener('blur', function () {
                this.style.boxShadow = 'none';
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            // Log the raw sessionStorage data for debugging
            console.log("Raw sessionStorage data:", {
                selectedProduct: sessionStorage.getItem("selectedProduct"),
                orderSummary: sessionStorage.getItem("orderSummary")
            });

            let product;
            try {
                // Try parsing selectedProduct first
                product = JSON.parse(sessionStorage.getItem("selectedProduct"));

                // If that fails, try orderSummary
                if (!product) {
                    product = JSON.parse(sessionStorage.getItem("orderSummary"));
                }
            } catch (error) {
                console.error("Error parsing sessionStorage:", error);
                alert("❌ Error parsing product data. Redirecting back...");
                window.location.href = "dashboard.html";
                return;
            }

            if (!product) {
                alert("❌ No product found. Redirecting back...");
                window.location.href = "dashboard.html";
                return;
            }


            //To show discount and apply  it using the api
// Add this function to fetch active rewards for a customer
async function fetchActiveRewards(customerId) {
    try {
        // Make sure customerId exists
        if (!customerId) {
            console.warn("No customer ID available for reward fetch");
            return null;
        }
        
        const res = await fetch(`http://localhost:3000/api/${customerId}/reward`);
        if (!res.ok) {
            throw new Error(`Failed to fetch rewards: ${res.status}`);
        }
        
        const data = await res.json();
        console.log("Rewards data from server:", data);

        if (Array.isArray(data.activeRewards) && data.activeRewards.length > 0) {
            // Sort by redeemedAt (latest first)
            const sorted = data.activeRewards.sort((a, b) => 
                new Date(b.redeemedAt) - new Date(a.redeemedAt));
            
            // Store the active reward in sessionStorage
            return sorted[0]; // Return the latest active reward
        }

        return null;
    } catch (err) {
        console.error("❌ Failed to fetch rewards:", err);
        return null;
    }
}


            // Function to safely get nested property
            function getNestedProperty(obj, path, defaultValue = 0) {
                return path.split('.').reduce((acc, part) =>
                    acc && acc[part] !== undefined ? acc[part] : defaultValue, obj);
            }

            // Function to update order summary
   // Update order summary function to properly apply discount from backend
   async function updateOrderSummary(product) {
    console.log("Product data for summary:", product);

    // Select all summary rows across BOTH pages
    const summaryRowsPage1 = document.querySelector('#page-1 .order-summary');
    const summaryRowsPage2 = document.querySelector('#page-2 .order-summary');

    if (!summaryRowsPage1 || !summaryRowsPage2) {
        console.error("❌ Could not find order summary elements");
        return;
    }

    const formatPrice = (price) => `Rs. ${parseFloat(price).toFixed(2)}`;

    // Extract core values
    const subtotal = getNestedProperty(product, 'subtotal') ||
        getNestedProperty(product, 'items[0].subtotal') ||
        (getNestedProperty(product, 'price', 0) * getNestedProperty(product, 'quantity', 1));
        const deliveryType = document.querySelector('input[name="deliveryType"]:checked').value;
        let deliveryCharge = deliveryType === "express" ? 300 : 150;

        if (subtotal >= 5000) {
            deliveryCharge = 0;
        }
    const tax = getNestedProperty(product, 'tax', 50);

    let discount = 0;
    let rewardName = "";

    // 🛒 Fetch active reward in real-time
    const customerId = localStorage.getItem("customerId");
    if (customerId) {
        try {
            const res = await fetch(`http://localhost:3000/api/${customerId}/reward`);
            if (res.ok) {
                const data = await res.json();
                console.log("Fetched rewards:", data);

                if (Array.isArray(data.activeRewards) && data.activeRewards.length > 0) {
                    const sortedRewards = data.activeRewards.sort((a, b) => 
                        new Date(b.redeemedAt) - new Date(a.redeemedAt));
                    
                    const activeReward = sortedRewards[0];

                    if (activeReward && activeReward.discount) {
                        if (activeReward.discount.type === "fixed") {
                            discount = parseFloat(activeReward.discount.value);
                        } else if (activeReward.discount.type === "percentage") {
                            discount = (parseFloat(activeReward.discount.value) / 100) * subtotal;
                        }
                        rewardName = activeReward.rewardName || "Discount";
                        console.log(`✅ Applied real-time discount: ${discount} (${activeReward.discount.type})`);
                    }
                }
            } else {
                console.warn("⚠️ Failed to fetch active rewards");
            }
        } catch (err) {
            console.error("❌ Error fetching rewards:", err);
        }
    }

    const totalAmount = subtotal + deliveryCharge + tax - discount;

    const updateSingleSummary = (summaryElement) => {
        const summaryRows = summaryElement.querySelectorAll('.summary-row, .total-row');

        if (summaryRows.length >= 5) {
            summaryRows[0].querySelector('span:last-child').textContent = formatPrice(subtotal);
            summaryRows[1].querySelector('span:last-child').textContent = formatPrice(deliveryCharge);
            
            const discountRow = summaryRows[2];
            discountRow.querySelector('span:last-child').textContent = `- ${formatPrice(discount)}`;
            
            if (discount > 0) {
                discountRow.style.color = '#38a169'; // Green
                discountRow.querySelector('span:first-child').innerHTML = '🏷️ Discount';
            } else {
                discountRow.style.color = '';
                discountRow.querySelector('span:first-child').innerHTML = 'Discount';
            }

            summaryRows[3].querySelector('span:last-child').textContent = formatPrice(tax);
            summaryRows[4].querySelector('span:last-child').textContent = formatPrice(totalAmount);
        }
    };

    // Update both page summaries
    updateSingleSummary(summaryRowsPage1);
    updateSingleSummary(summaryRowsPage2);

    // Update Khalti quick payment preview
    const khaltiTotalElement = document.querySelector('#khalti-details .summary-row span:last-child');
    if (khaltiTotalElement) {
        khaltiTotalElement.textContent = formatPrice(totalAmount);
    }

    // Update estimated delivery time text
    const estimatedDelivery = deliveryType === "express" ? "1-2 business days" : "3-5 business days";
    const deliveryTimeElements = document.querySelectorAll('.delivery-time');
    deliveryTimeElements.forEach(el => {
        el.textContent = estimatedDelivery;
    });

    // Show discount message if a reward applied
    const rewardMsgEl = document.getElementById("reward-applied-msg");
    if (rewardMsgEl) {
        if (discount > 0) {
            rewardMsgEl.innerText = `🎁 ${rewardName} applied!`;
            rewardMsgEl.style.display = "block";
        } else {
            rewardMsgEl.style.display = "none";
        }
    }
}


            // Update order summary
            updateOrderSummary(product);

            // Add event listeners to delivery type radio buttons
            const deliveryTypeRadios = document.querySelectorAll('input[name="deliveryType"]');
            deliveryTypeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    updateOrderSummary(product);

                    // Update radio option styling
                    const radioOptions = document.querySelectorAll(
                        '.radio-option[data-value="standard"], .radio-option[data-value="express"]'
                    );
                    radioOptions.forEach(option => {
                        option.classList.remove('selected');
                        option.querySelector('.checkmark').textContent = '';
                    });

                    const selectedOption = document.querySelector(
                        `.radio-option[data-value="${radio.value}"]`);
                    selectedOption.classList.add('selected');
                    selectedOption.querySelector('.checkmark').textContent = '✓';
                });
            });

            // Prepare payment page details
            if (document.getElementById('delivery-name')) {
                document.getElementById('delivery-name').textContent = document.getElementById('fullName')
                    .value;
                document.getElementById('delivery-phone').textContent = document.getElementById('phone').value;
                document.getElementById('delivery-full-address').textContent =
                    `${document.getElementById('address').value}, ${document.getElementById('city').value}, ${document.getElementById('zipCode').value}`;

                const deliveryType = document.querySelector('input[name="deliveryType"]:checked').value;
                document.querySelector('.delivery-type').textContent =
                    deliveryType === 'express' ? 'Express Delivery (1-2 days)' : 'Standard Delivery (3-5 days)';
            }
        });
// Update the submitOrder function to remove manual reward handling since backend handles it
async function submitOrder(paymentMethod) {
    const orderSummaryStr = sessionStorage.getItem("orderSummary");
    const selectedProductStr = sessionStorage.getItem("selectedProduct");

    let product = null;
    try {
        if (orderSummaryStr) {
            product = JSON.parse(orderSummaryStr);
            console.log("Using orderSummary data:", product);
        } else if (selectedProductStr) {
            product = JSON.parse(selectedProductStr);
            console.log("Using selectedProduct data:", product);
        }
    } catch (e) {
        console.error("❌ Failed to parse sessionStorage data:", e);
    }

    const customerId = localStorage.getItem("customerId");
    const customerEmail = localStorage.getItem("userEmail");
    const customerName = localStorage.getItem("username");

    if (!product) {
        alert("❌ Missing data. Redirecting to homepage.");
        window.location.href = "dashboard.html";
        return;
    }

    // Format products properly based on whether it's a cart or single product
    const formattedProducts = product.items && Array.isArray(product.items) ?
        product.items.map(item => ({
            productId: item.productId || item._id,
            quantity: item.quantity || 1,
            size: item.size || "N/A",
            price: item.price || 0
        })) :
        [{
            productId: product.productId || product._id,
            quantity: product.quantity || 1,
            size: product.size || "N/A",
            price: product.price || 0
        }];

    // Calculate actual total cost for the order including delivery
    const deliveryType = document.querySelector('input[name="deliveryType"]:checked').value;
    const deliveryCharge = deliveryType === "express" ? 300 : 150;

    const activeReward = JSON.parse(sessionStorage.getItem("activeReward"));

    
    const orderData = {
        rewardId: activeReward ? activeReward._id : null, // ✅ safe check
        customerId,
        customerEmail,
        customerName,
        products: formattedProducts,
        deliveryInfo: {
            fullName: document.getElementById("fullName").value,
            phone: document.getElementById("phone").value,
            address: document.getElementById("address").value,
            city: document.getElementById("city").value,
            postalCode: document.getElementById("zipCode").value,
            instructions: document.getElementById("paymentInstructions")?.value || ""
        },
        deliveryType: deliveryType === "express" ? "Express Delivery" : "Standard Delivery",
        deliveryCharge: deliveryCharge,
        estimatedDeliveryDate: new Date(),
        paymentStatus: paymentMethod === "khalti" ? "Paid" : "Unpaid",
        paymentMethod: paymentMethod === "khalti" ? "khalti" : "Cash"
    };

    try {
        console.log("📤 Sending order data:", JSON.stringify(orderData, null, 2));

        const res = await fetch("http://localhost:3000/api/trackorder", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(orderData),
        });

        const result = await res.json();

        if (res.ok) {
            console.log("✅ Order placed successfully:", result);
            
            // Clear cart/sessionStorage data
            sessionStorage.removeItem("selectedProduct");
            sessionStorage.removeItem("orderSummary");
            sessionStorage.removeItem("redeemedReward");
            sessionStorage.removeItem("activeReward");


            // Redirect to invoice with orderId and reference
            window.location.href = `invoice.html?orderId=${result.order._id}&ref=${result.order.orderReference}`;
        } else {
            console.error("❌ Order failed:", result);
            alert("❌ " + (result.message || "Unknown error"));
        }

    } catch (err) {
        console.error("❌ Network or server error:", err);
        alert("❌ Something went wrong. Please try again.");
    }
}

// Update the function to get nested properties safely
function getNestedProperty(obj, path, defaultValue = 0) {
    if (!obj) return defaultValue;
    return path.split('.').reduce((acc, part) =>
        acc && acc[part] !== undefined ? acc[part] : defaultValue, obj);
}

// Update order summary function to show default discounts until server response
function updateOrderSummary(product) {
    console.log("Product data for summary:", product);

    // Select all summary rows across BOTH pages
    const summaryRowsPage1 = document.querySelector('#page-1 .order-summary');
    const summaryRowsPage2 = document.querySelector('#page-2 .order-summary');

    if (!summaryRowsPage1 || !summaryRowsPage2) {
        console.error("Could not find order summary elements");
        return;
    }

    // Format with Rs
    const formatPrice = (price) => `Rs. ${price.toFixed(2)}`;

    // Fallback-safe nested property getter
    const getNestedProperty = (obj, path, defaultValue = 0) => {
        return path.split('.').reduce((acc, part) => acc && acc[part] !== undefined ? acc[part] : defaultValue, obj);
    };

    // Get core amounts
    const subtotal = getNestedProperty(product, 'subtotal') ||
        getNestedProperty(product, 'items[0].subtotal') ||
        getNestedProperty(product, 'price', 0) * getNestedProperty(product, 'quantity', 1);

    const deliveryCharge = getNestedProperty(product, 'deliveryCharge') ||
        getNestedProperty(product, 'shipping', 
            document.querySelector('input[name="deliveryType"]:checked')?.value === "express" ? 300 : 150);

    let discount = 0;

    // ✅ Fetch reward from sessionStorage and apply
    const reward = JSON.parse(sessionStorage.getItem("activeReward") || "null");
    if (reward && reward.discount) {
        const { type, value } = reward.discount;
        if (type === "fixed") {
            discount = value;
        } else if (type === "percentage") {
            discount = Math.round((value / 100) * subtotal);
        }
        console.log("✅ Reward discount applied:", discount);
    }

    const tax = getNestedProperty(product, 'tax', 50);
    const totalAmount = subtotal + deliveryCharge + tax - discount;

    // DOM updater
    const updateSummary = (summaryElement) => {
        const summaryRows = summaryElement.querySelectorAll('.summary-row, .total-row');

        if (summaryRows.length >= 5) {
            summaryRows[0].querySelector('span:last-child').textContent = formatPrice(subtotal);
            summaryRows[1].querySelector('span:last-child').textContent = formatPrice(deliveryCharge);
            summaryRows[2].querySelector('span:last-child').textContent = `- ${formatPrice(discount)}`;
            summaryRows[3].querySelector('span:last-child').textContent = formatPrice(tax);
            summaryRows[4].querySelector('span:last-child').textContent = formatPrice(totalAmount);
        }
    };

    // Update both summary sections
    updateSummary(summaryRowsPage1);
    updateSummary(summaryRowsPage2);

    // Update Khalti quick preview
    const khaltiTotalElement = document.querySelector('#khalti-details .summary-row span:last-child');
    if (khaltiTotalElement) {
        khaltiTotalElement.textContent = formatPrice(totalAmount);
    }

    // Update estimated delivery
    const deliveryType = document.querySelector('input[name="deliveryType"]:checked')?.value;
    const estimatedDelivery = deliveryType === 'express' ? "1-2 business days" : "3-5 business days";

    const deliveryTimeElements = document.querySelectorAll('.delivery-time');
    deliveryTimeElements.forEach(el => {
        el.textContent = estimatedDelivery;
    });

    // Optional: Show reward message
    if (reward?.rewardName) {
        const rewardMsgEl = document.getElementById("reward-applied-msg");
        if (rewardMsgEl) {
            rewardMsgEl.innerText = `🎁 ${reward.rewardName} applied`;
            rewardMsgEl.style.display = "block";
        }
    }
}


// Updated Khalti payment completion to handle the response from backend
async function completeKhaltiPayment(purchaseOrderId, status) {
    try {
        console.log("Completing payment with:", { purchaseOrderId, status });
        
        // Show loading indicator
        const loadingMessage = document.createElement("div");
        loadingMessage.innerHTML = "Processing your payment...";
        loadingMessage.style.position = "fixed";
        loadingMessage.style.top = "50%";
        loadingMessage.style.left = "50%";
        loadingMessage.style.transform = "translate(-50%, -50%)";
        loadingMessage.style.padding = "20px";
        loadingMessage.style.background = "white";
        loadingMessage.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
        loadingMessage.style.borderRadius = "5px";
        loadingMessage.style.zIndex = "9999";
        document.body.appendChild(loadingMessage);
        
        // Make the API call to complete the payment
        const response = await fetch(`http://localhost:3000/api/payment/complete-khalti-payment?purchase_order_id=${purchaseOrderId}&status=${status}`);
        const result = await response.json();
        
        // Remove loading message
        document.body.removeChild(loadingMessage);
        
        if (result.success) {
            console.log("Full payment completion response:", result);
            
            // If backend applied a discount, we could show it
            if (result.order && result.order.discount) {
                console.log(`💰 Discount applied: ${result.order.discount}`);
            }
            
            // If backend used a reward, we could show it
            if (result.order && result.order.usedRewardId) {
                console.log(`🎁 Used reward: ${result.order.usedRewardId}`);
            }
            
            // Clean up stored data
            sessionStorage.removeItem("selectedProduct");
            sessionStorage.removeItem("orderSummary");
            sessionStorage.removeItem("redeemedReward"); // Clear this since backend handles rewards
            sessionStorage.removeItem("activeReward");

            // Show success and redirect
            alert("✅ Payment successful! Redirecting to your invoice...");
            console.log("📧 Confirmation email sent");
            window.location.href = `invoice.html?orderId=${result.order._id}&ref=${result.order.orderReference}`;
        } else {
            alert("❌ " + (result.message || "Failed to complete payment verification"));
        }
    } catch (error) {
        console.error("Error completing payment:", error);
        alert("❌ Server error. Please contact support with your payment reference.");
    }
}

// Helper function to process Khalti payment
async function processKhaltiPayment(payload) {
    // Get customer information from localStorage
    const customerId = localStorage.getItem("customerId");
    
    // Validate customerId exists
    if (!customerId) {
        alert("You must be logged in to make a payment. Please log in and try again.");
        return;
    }
    
    // Get delivery information from the form
    const deliveryInfo = {
        fullName: document.getElementById("fullName").value,
        phone: document.getElementById("phone").value,
        address: document.getElementById("address").value,
        city: document.getElementById("city").value,
        postalCode: document.getElementById("zipCode").value,
        instructions: document.getElementById("paymentInstructions")?.value || ""
    };
    
    // Add customer information to the payload
    const enhancedPayload = {
        ...payload,
        customerId: customerId,
        deliveryInfo: deliveryInfo,
        deliveryType: document.querySelector('input[name="deliveryType"]:checked').value === "express" ? 
            "Express Delivery" : "Standard Delivery"
        // No need to pass redeemedReward - backend will handle this automatically
    };
    
    console.log("Sending payment request with customerId:", customerId);
    console.log("Full payload:", enhancedPayload);

    try {
        const res = await fetch("http://localhost:3000/api/payment/initialize-khalti", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(enhancedPayload),
        });

        const data = await res.json();

        if (data.success && data.paymentURL) {
            // Store the purchase ID to reference after payment completion
            sessionStorage.setItem("khaltiPurchaseId", data.purchase._id);
            
            // Redirect to Khalti Payment page
            window.location.href = data.paymentURL;
        } else {
            alert("Payment initiation failed: " + (data.message || "Something went wrong"));
        }
    } catch (err) {
        console.error("Error initializing payment", err);
        alert("Error initiating Khalti payment");
    }
}


        

// Update order summary function to use backend discount
function updateOrderSummary(product) {
    console.log("Product data for summary:", product);

    // Select all summary rows across BOTH pages explicitly
    const summaryRowsPage1 = document.querySelector('#page-1 .order-summary');
    const summaryRowsPage2 = document.querySelector('#page-2 .order-summary');

    if (!summaryRowsPage1 || !summaryRowsPage2) {
        console.error("Could not find order summary elements");
        return;
    }

    // Function to format price with Nepali Rupees sign
    const formatPrice = (price) => {
        return `Rs. ${price.toFixed(2)}`;
    };

    // Intelligently extract values with fallback
    const subtotal = getNestedProperty(product, 'subtotal') ||
        getNestedProperty(product, 'items[0].subtotal') ||
        getNestedProperty(product, 'price', 0) * getNestedProperty(product, 'quantity', 1);

    const deliveryCharge = getNestedProperty(product, 'deliveryCharge') ||
        getNestedProperty(product, 'shipping', 150);

    // Use discount from product data directly - no more complicated calculation
    // This will be updated from backend response when order is submitted
    let discount = getNestedProperty(product, 'discount', 0);

    const tax = getNestedProperty(product, 'tax') ?? 0;

    const totalAmount = getNestedProperty(product, 'total') ||
        getNestedProperty(product, 'totalAmount') ||
        (subtotal + deliveryCharge - discount + tax);

    // Function to update a specific order summary
    const updateSummary = (summaryElement) => {
        const summaryRows = summaryElement.querySelectorAll('.summary-row, .total-row');

        summaryRows[0].querySelector('span:last-child').textContent = formatPrice(subtotal);
        summaryRows[1].querySelector('span:last-child').textContent = formatPrice(deliveryCharge);
        summaryRows[2].querySelector('span:last-child').textContent = `- ${formatPrice(discount)}`;
        summaryRows[3].querySelector('span:last-child').textContent = formatPrice(tax);
        summaryRows[4].querySelector('span:last-child').textContent = formatPrice(totalAmount);
    };

    // Update both page's summaries
    updateSummary(summaryRowsPage1);
    updateSummary(summaryRowsPage2);

    // Update the Khalti details total amount
    const khaltiTotalElement = document.querySelector(
        '#khalti-details .summary-row span:last-child');
    if (khaltiTotalElement) {
        khaltiTotalElement.textContent = formatPrice(totalAmount);
    }

    // Update Estimated Delivery
    const deliveryType = document.querySelector('input[name="deliveryType"]:checked').value;
    const estimatedDelivery = deliveryType === 'express' ? "1-2 business days" :
        "3-5 business days";

    const deliveryTimeElements = document.querySelectorAll('.delivery-time');
    deliveryTimeElements.forEach(el => {
        el.textContent = estimatedDelivery;
    });
}

// Updated Khalti payment completion function to update order summary with backend discount
async function completeKhaltiPayment(purchaseOrderId, status) {
    try {
        console.log("Completing payment with:", { purchaseOrderId, status });
        
        // Show loading indicator
        const loadingMessage = document.createElement("div");
        loadingMessage.innerHTML = "Processing your payment...";
        loadingMessage.style.position = "fixed";
        loadingMessage.style.top = "50%";
        loadingMessage.style.left = "50%";
        loadingMessage.style.transform = "translate(-50%, -50%)";
        loadingMessage.style.padding = "20px";
        loadingMessage.style.background = "white";
        loadingMessage.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
        loadingMessage.style.borderRadius = "5px";
        loadingMessage.style.zIndex = "9999";
        document.body.appendChild(loadingMessage);
        
        // IMPORTANT: Use the parameter name that the backend expects
        const response = await fetch(`http://localhost:3000/api/payment/complete-khalti-payment?purchase_order_id=${purchaseOrderId}&status=${status}`);
        const result = await response.json();
        
        // Remove loading message
        document.body.removeChild(loadingMessage);
        
        if (result.success) {
            // Clean up stored data
            sessionStorage.removeItem("selectedProduct");
            sessionStorage.removeItem("orderSummary");
            sessionStorage.removeItem("redeemedReward"); // Clear this since backend handles rewards
            
            // Show success and redirect
            alert("✅ Payment successful! Redirecting to your invoice...");
            console.log("📧 Confirmation email sent");
            window.location.href = `invoice.html?orderId=${result.order._id}&ref=${result.order.orderReference}`;
        } else {
            alert("❌ " + (result.message || "Failed to complete payment verification"));
        }
    } catch (error) {
        console.error("Error completing payment:", error);
        alert("❌ Server error. Please contact support with your payment reference.");
    }
}



        // Khalti integration
        document.getElementById("pay-khalti").addEventListener("click", async () => {
    // Validate delivery information first
    if (!validateDeliveryInfo()) {
        return;
    }
    
    // Try to get data from orderSummary first (for cart checkouts)
    const orderSummaryStr = sessionStorage.getItem("orderSummary");
    const selectedProductStr = sessionStorage.getItem("selectedProduct");

    let orderData;
    try {
        if (orderSummaryStr) {
            orderData = JSON.parse(orderSummaryStr);
            console.log("Using orderSummary data for payment:", orderData);
        } else if (selectedProductStr) {
            orderData = JSON.parse(selectedProductStr);
            console.log("Using selectedProduct data for payment:", orderData);
        } else {
            return alert("Order data missing!");
        }
    } catch (e) {
        console.error("Failed to parse order data:", e);
        return alert("Invalid order data!");
    }

    // For cart orders (multiple items)
    if (orderData.items && Array.isArray(orderData.items) && orderData.items.length > 0) {
        const payload = {
            orderId: orderData.orderId || Date.now().toString(),
            totalAmount: orderData.total || orderData.totalAmount,
            tax: orderData.tax || 0,
            items: orderData.items.map(item => ({
                productId: item.productId || item._id,
                quantity: item.quantity || 1,
                unitPrice: item.price || 0
            })),
            website_url: "http://localhost:3000"
        };

        // Process payment for cart items
        processKhaltiPayment(payload);
    }
    // For single product orders
    else {
        // Create a proper payload for single product purchases
        const payload = {
            orderId: Date.now().toString(),
            totalAmount: orderData.price * (orderData.quantity || 1) + 
                         (document.querySelector('input[name="deliveryType"]:checked').value === "express" ? 300 : 150),
            tax: orderData.tax || 50,
            items: [{
                productId: orderData.productId || orderData._id,
                quantity: orderData.quantity || 1,
                unitPrice: orderData.price || 0
            }],
            website_url: "http://localhost:3000"
        };

        console.log("Single product payload:", payload);
        processKhaltiPayment(payload);
    }
});

// Add a validation helper function
function validateDeliveryInfo() {
    // Get form elements
    const fullNameInput = document.getElementById('fullName');
    const phoneInput = document.getElementById('phone');
    const addressInput = document.getElementById('address');
    const cityInput = document.getElementById('city');
    const zipCodeInput = document.getElementById('zipCode');
    
    // Get error elements
    const nameError = document.getElementById('nameError');
    const phoneError = document.getElementById('phoneError');
    const addressError = document.getElementById('addressError');
    const cityError = document.getElementById('cityError');
    const zipError = document.getElementById('zipError');
    
    // Validate each field
    const isNameValid = validateInput(
        fullNameInput,
        nameError,
        fullNameInput.value.length >= 3,
        'Full name must be at least 3 characters'
    );
    
    const isPhoneValid = validateInput(
        phoneInput,
        phoneError,
        phoneInput.value.length >= 10,
        'Please enter a valid phone number (at least 10 digits)'
    );
    
    const isAddressValid = validateInput(
        addressInput,
        addressError,
        addressInput.value.trim() !== '',
        'Please enter your complete address'
    );
    
    const isCityValid = validateInput(
        cityInput,
        cityError,
        cityInput.value.trim() !== '',
        'Please enter your city'
    );
    
    const isZipValid = validateInput(
        zipCodeInput,
        zipError,
        zipCodeInput.value.trim() !== '',
        'Please enter a valid zip/postal code'
    );
    
    return isNameValid && isPhoneValid && isAddressValid && isCityValid && isZipValid;
}

        // Helper function to process Khalti payment
        async function processKhaltiPayment(payload) {
    // Get customer information from localStorage
    const customerId = localStorage.getItem("customerId");
    
    // Validate customerId exists
    if (!customerId) {
        alert("You must be logged in to make a payment. Please log in and try again.");
        return;
    }
    
    // Get delivery information from the form
    const deliveryInfo = {
        fullName: document.getElementById("fullName").value,
        phone: document.getElementById("phone").value,
        address: document.getElementById("address").value,
        city: document.getElementById("city").value,
        postalCode: document.getElementById("zipCode").value,
        instructions: document.getElementById("paymentInstructions")?.value || ""
    };
    
    // Add customer information to the payload - ENSURE THIS IS STRUCTURED PROPERLY
    const enhancedPayload = {
        ...payload,
        customerId: customerId, // Make sure this is an actual value, not null or undefined
        deliveryInfo: deliveryInfo,
        deliveryType: document.querySelector('input[name="deliveryType"]:checked').value === "express" ? 
            "Express Delivery" : "Standard Delivery"
    };
    
    console.log("Sending payment request with customerId:", customerId);
    console.log("Full payload:", enhancedPayload); // Add this line to debug

    try {
        const res = await fetch("http://localhost:3000/api/payment/initialize-khalti", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(enhancedPayload),
        });


        const data = await res.json();

        if (data.success && data.paymentURL) {
            // Store the purchase ID to reference after payment completion
            sessionStorage.setItem("khaltiPurchaseId", data.purchase._id);
            
            // Redirect to Khalti Payment page
            window.location.href = data.paymentURL;
        } else {
            alert("Payment initiation failed: " + (data.message || "Something went wrong"));
        }
    } catch (err) {
        console.error("Error initializing payment", err);
        alert("Error initiating Khalti payment");
    }
}


    // Handle redirect from Khalti after payment
window.addEventListener("DOMContentLoaded", async () => {
    // Check if we're returning from Khalti
    const url = new URL(window.location.href);
    const urlParams = url.searchParams;
    
    // Extract the purchase_order_id parameter
    let purchaseOrderId = urlParams.get("purchase_order_id");
    const status = urlParams.get("status");
    
    console.log("URL Parameters:", {
        purchaseOrderId,
        status,
        fullUrl: window.location.href
    });
    
    if (purchaseOrderId && status) {
        // We have returned from Khalti
        // Clean up the ID by removing anything after a slash
        if (purchaseOrderId.includes('/')) {
            purchaseOrderId = purchaseOrderId.split('/')[0];
        }

        // Fetch active rewards if user is logged in
    const customerId = localStorage.getItem("customerId");
    if (customerId) {
        try {
            const reward = await fetchActiveRewards(customerId);
            if (reward) {
                console.log("Active reward loaded:", reward);
                // This will trigger a UI update with the reward applied
                updateOrderSummary(product);
            }
        } catch (error) {
            console.error("Error fetching rewards:", error);
        }
    }
        
        // Now call the API with the correct parameter name that the backend expects
        completeKhaltiPayment(purchaseOrderId, status);
    }
});

    </script>
</body>

</html>